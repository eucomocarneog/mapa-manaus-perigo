<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Manaus Seguro — Mobile 9:16 (GNews)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root{/*bg:#f0f2f5;--card:#fff;--muted:#6b7280;--accent:#ff6b3d*/}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial,sans-serif;color:#111}
  .frame{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box}
  .viewport{ width: calc(min(420px,92vw)); aspect-ratio:9/16; background:#fff; border-radius:12px; position:relative; box-shadow:0 12px 30px rgba(0,0,0,0.12); overflow:hidden}
  header{height:56px;display:flex;align-items:center;gap:12px;padding:8px 12px;background:linear-gradient(180deg,#fff,#fbfbfd); box-sizing:border-box}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#ffd479,var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
  .title{font-size:15px;font-weight:800}
  .subtitle{font-size:11px;color:var(--muted);margin-top:2px}
  .map-wrap{position:absolute;left:8px;right:8px;top:64px;bottom:12px;border:1px solid #cfcfcf;border-radius:8px;overflow:hidden}
  #map{width:100%;height:100%}
  #dangerBtn{position:absolute;right:16px;top:74px;background:#b30000;color:#fff;padding:10px 12px;border:none;border-radius:6px;cursor:pointer;z-index:1200;font-weight:700}
  #newsBox{position:absolute;left:50%;transform:translateX(-50%);bottom:22px;background:var(--card);padding:10px;border-radius:8px;width:86%;max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,0.12);z-index:1200;display:none}
  #newsBox h4{margin:0 0 6px 0;font-size:15px}
  .newsItem{padding:6px 4px;margin-bottom:6px;border:1px solid #f0f2f5;border-radius:6px;background:#fff}
  .newsItem a{color:#0b5ed7;text-decoration:none;font-size:13px}
  .newsItem .meta{display:block;color:var(--muted);font-size:12px;margin-bottom:4px}
  .info{position:absolute;left:12px;bottom:12px;color:var(--muted);font-size:12px;z-index:1100}
  .spinner{width:22px;height:22px;border:3px solid #eee;border-top-color:#0b84ff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-left:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="frame">
    <div class="viewport" role="application" aria-label="Manaus Seguro 9:16">
      <header>
        <div class="logo">MS</div>
        <div>
          <div class="title">Manaus Seguro</div>
          <div class="subtitle">Mapa — teste móvel (9:16)</div>
        </div>
      </header>

      <div class="map-wrap"><div id="map" aria-label="Mapa interativo"></div></div>

      <button id="dangerBtn" aria-haspopup="true">É perigoso aqui?</button>

      <div id="newsBox" aria-live="polite" aria-atomic="true">
        <h4>Notícias locais</h4>
        <div id="newsList"></div>
      </div>

      <div class="info">Toque em "É perigoso aqui?" para buscar notícias reais (GNews) da área central do mapa.<span id="loading" style="display:none" class="spinner"></span></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ---- Config mapa ----
    const CENTER = [-3.119028, -60.021731]; // Manaus center
    const SOUTH = -3.35, NORTH = -2.95, WEST = -60.20, EAST = -59.80;
    const bounds = [[SOUTH, WEST], [NORTH, EAST]];

    const map = L.map('map', {
      center: CENTER,
      zoom: 13,
      minZoom: 12,
      maxZoom: 17,
      maxBounds: bounds,
      zoomControl: true,
      attributionControl: false
    });
    map.on('drag', () => map.panInsideBounds(bounds, { animate:false }));
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // small center marker
    L.circleMarker(CENTER, { radius:4, color:'#0b84ff', fillColor:'#0b84ff', fillOpacity:0.9 }).addTo(map);

    // ---- Regions grouped by 4 neighborhoods ----
    const regionGroups = {
      "oeste_1": { name:"Zona Oeste (Compensa, Santo Antônio, Nova Esperança, Cidade Nova)", bbox:[-3.00,-60.11,-3.14,-59.98], neighborhoods:["Compensa","Santo Antônio","Nova Esperança","Cidade Nova"] },
      "oeste_2": { name:"Ponta Negra / Vizinhança (Ponta Negra, Parque das Artes, Alvorada, Novo Israel)", bbox:[-3.06,-60.10,-3.16,-59.94], neighborhoods:["Ponta Negra","Parque das Artes","Alvorada","Novo Israel"] },
      "centro": { name:"Centro / Adjacentes (Centro, Adrianópolis, Praça 14, Dom Pedro)", bbox:[-3.10,-60.03,-3.16,-59.98], neighborhoods:["Centro","Adrianópolis","Praça 14","Dom Pedro"] },
      "norte_1": { name:"Zona Norte (Cidade Nova, Cidade de Deus, Colônia Oliveira, São José)", bbox:[-2.97,-60.13,-3.05,-60.00], neighborhoods:["Cidade Nova","Cidade de Deus","Colônia Oliveira","São José"] },
      "sul_1": { name:"Zona Sul (São Jorge, Parque 10, Flores, Puraquequara)", bbox:[-3.08,-60.05,-3.20,-59.95], neighborhoods:["São Jorge","Parque 10","Flores","Puraquequara"] }
    };

    function inBBox(lat, lng, bbox){
      const [latTop, lngLeft, latBottom, lngRight] = bbox;
      const maxLat = Math.max(latTop, latBottom);
      const minLat = Math.min(latTop, latBottom);
      const minLng = Math.min(lngLeft, lngRight);
      const maxLng = Math.max(lngLeft, lngRight);
      return (lat <= maxLat && lat >= minLat && lng >= minLng && lng <= maxLng);
    }

    function detectRegionGroup(lat,lng){
      for(const key in regionGroups){
        const g = regionGroups[key];
        if(inBBox(lat,lng,g.bbox)) return key;
      }
      return null;
    }

    // ---- GNews API integration (client-side) ----
    const GNEWS_KEY = "487998612e6d3a985aa5578badddf7e2"; // user-provided key embedded for test (visible in client JS)
    const GNEWS_ENDPOINT = "https://gnews.io/api/v4/search";

    // helper: ISO date for X years ago
    function isoDateYearsAgo(years){
      const d = new Date();
      d.setFullYear(d.getFullYear() - years);
      return d.toISOString().split('T')[0];
    }

    async function fetchNewsForQuery(q){
      const fromDate = isoDateYearsAgo(3); // last 3 years
      const params = new URLSearchParams({
        q: q,
        lang: 'pt',
        country: 'br',
        max: '10',
        from: fromDate,
        token: GNEWS_KEY
      });
      const url = GNEWS_ENDPOINT + "?" + params.toString();
      const res = await fetch(url);
      if(!res.ok){
        throw new Error('Erro na requisição GNews: ' + res.status);
      }
      const data = await res.json();
      return data.articles || [];
    }

    // UI elements
    const dangerBtn = document.getElementById('dangerBtn');
    const newsBox = document.getElementById('newsBox');
    const newsList = document.getElementById('newsList');
    const loading = document.getElementById('loading');

    dangerBtn.addEventListener('click', async ()=>{
      newsList.innerHTML = '';
      newsBox.style.display = 'block';
      loading.style.display = 'inline-block';

      const c = map.getCenter();
      const regionKey = detectRegionGroup(c.lat, c.lng);
      let neighborhoods = [];
      let label = 'Manaus';
      if(regionKey){
        neighborhoods = regionGroups[regionKey].neighborhoods;
        label = regionGroups[regionKey].name;
      } else {
        neighborhoods = ['Manaus'];
      }

      const header = document.createElement('div');
      header.className = 'newsItem';
      header.innerHTML = `<strong>Buscando notícias para:</strong><br/><span class="meta">${label}</span>`;
      newsList.appendChild(header);

      try{
        // For each neighborhood, perform a query and append top results
        for(const nb of neighborhoods){
          const query = `${nb} Manaus assalto OR furto OR homicídio OR acidente`;
          const articles = await fetchNewsForQuery(query);
          if(articles.length === 0){
            const div = document.createElement('div'); div.className='newsItem'; div.textContent = `Nenhuma notícia recente encontrada para ${nb}.`; newsList.appendChild(div);
          } else {
            // show up to 3 articles per neighborhood
            const slice = articles.slice(0,3);
            slice.forEach(a => {
              const div = document.createElement('div'); div.className='newsItem';
              const meta = document.createElement('span'); meta.className='meta'; meta.textContent = (new Date(a.publishedAt)).toLocaleDateString();
              const link = document.createElement('a'); link.href = a.url; link.target='_blank'; link.rel='noopener noreferrer'; link.textContent = a.title;
              div.appendChild(meta); div.appendChild(link); newsList.appendChild(div);
            });
          }
        }
      }catch(err){
        const div = document.createElement('div'); div.className='newsItem'; div.textContent = 'Erro ao buscar notícias: ' + err.message; newsList.appendChild(div);
      }finally{
        loading.style.display = 'none';
      }

      // auto-hide after 60s
      setTimeout(()=> { newsBox.style.display = 'none'; }, 60000);
    });

    map.on('click', ()=> { newsBox.style.display = 'none'; });

    window.addEventListener('resize', ()=> map.invalidateSize());
  </script>
</body>
</html>
